name: Build a Dockerfile

on:
  workflow_call:
    inputs:
      dockerfile:
        description: "The path to the Dockerfile"
        required: true
        type: string
      rebuild:
        description: "Whether to rebuild the image if the source files have not changed"
        required: false
        type: boolean
        default: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
    concurrency:
      group: ${{ inputs.dockerfile }}-${{ matrix.platform }}
      cancel-in-progress: false
    runs-on: ${{ matrix.runner }}
    defaults:
      run:
        shell: bash -euo pipefail {0}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract image metadata
        id: meta
        uses: ZnqbuZ/Dockerfiles/.github/actions/parse-metadata@ci
        with:
          namespace: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerfile: ${{ inputs.dockerfile }}
          platform: ${{ matrix.platform }}

      - name: Cache build hash
        uses: actions/cache@v4
        with:
          path: .build-hash
          key: build-hash:${{ steps.meta.outputs.full-name }}

      - name: Compare hash
        id: hash
        run: |
          HASH_FILE=.build-hash
          if [ ! -f "$HASH_FILE" ]; then
            echo > "$HASH_FILE"
          fi
          
          HASH=$(cat "$HASH_FILE")
          DIR_HASH=$(find "${{ steps.meta.outputs.dir }}" -type f -print0 | sort -z | xargs -0 sha256sum 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "")
          
          if [ "$DIR_HASH" != "$HASH" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "$DIR_HASH" > "$HASH_FILE"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
          
          cat "$HASH_FILE"
        shell: bash -euo pipefail {0}

      - name: Build
        id: build
        if: steps.hash.outputs.changed == 'true' || inputs.rebuild == 'true'
        run: echo "value=true" >> "$GITHUB_OUTPUT"

      - name: Pre-build script
        if: steps.build.outputs.value == 'true'
        run: |
          cd $(dirname "${{ inputs.dockerfile }}")
          if [[ -f "pre-build.sh" ]]; then
              echo "Running pre-build.sh..."
              chmod +x pre-build.sh
              ./pre-build.sh
          else
              echo "No pre-build.sh found, skipped."
          fi

      - name: Set up Docker Buildx
        if: steps.build.outputs.value == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.build.outputs.value == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Get remote digest
        if: steps.build.outputs.value == 'true'
        id: remote-digest
        run: echo "value=$(docker manifest inspect "${{ steps.meta.full-name }}" 2>/dev/null | jq -r '.config.digest' || echo "")" >> "$GITHUB_OUTPUT"

      - name: Generate tags
        if: steps.build.outputs.value == 'true'
        id: tags
        run: |
          {
              echo "value<<EOF"
              echo "${{ steps.meta.full-name }}"
              echo "${{ steps.meta.outputs.name }}:${{ github.sha }}${{ steps.meta.outputs.suffix }}"
              echo "${{ steps.meta.outputs.name }}:$(date +%Y%m%d%H%M)${{ steps.meta.outputs.suffix }}"
              echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push Docker image
        if: steps.build.outputs.value == 'true'
        uses: docker/build-push-action@v6
        with:
          file: ${{ inputs.dockerfile }}
          context: ${{ steps.meta.outputs.dir }}
          pull: true
          push: false
          load: true
          platforms: ${{ matrix.platform }}
          tags: ${{ steps.tags.outputs.value }}
          provenance: false
          sbom: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=${{ steps.meta.outputs.name }}
            org.opencontainers.image.description=Custom Docker image from ${{ inputs.dockerfile }}
            org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT
          build-args: |
            CACHE_BUST=${{ github.sha }}

      - name: Get local digest
        if: steps.build.outputs.value == 'true'
        id: local-digest
        run: echo "value=$(docker manifest inspect "${{ steps.meta.full-name }}" 2>/dev/null | jq -r '.config.digest' || echo "")" >> "$GITHUB_OUTPUT"

      - name: Push image
        if: steps.build.outputs.value == 'true' && (steps.local-digest.outputs.value != steps.remote-digest.outputs.value)
        run: |
          read -r -a TAGS <<< "${{ steps.tags.outputs.value }}"
          
          for TAG in "${TAGS[@]}"; do
            docker push "$TAG"
          done

  update-manifest:
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        shell: bash -euo pipefail {0}
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract image metadata
        id: meta
        uses: ZnqbuZ/Dockerfiles/.github/actions/parse-metadata@ci
        with:
          namespace: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerfile: ${{ inputs.dockerfile }}

      - name: Update manifest
        run: |
          declare -r SUFFIXES=("amd64" "arm64")
          
          IMAGE_NAME="${{ steps.meta.outputs.name }}"
          IMAGE_TAG="${{ steps.meta.outputs.tag }}"
          
          echo "Starting manifest update process for image: ${IMAGE_NAME}"
          for TAG in "${IMAGE_TAG}"; do
            echo "::group::âš™ï¸ Processing manifest for tag: ${TAG}"

            declare -a AMEND_ARGS=()
            for SUFFIX in "${SUFFIXES[@]}"; do
              AMEND_ARGS+=("--amend" "${IMAGE_NAME}:${TAG}-${SUFFIX}")
            done

            echo "ðŸš¢ Updating manifest: ${IMAGE_NAME}:${TAG}"
            docker manifest create "${IMAGE_NAME}:${TAG}" "${AMEND_ARGS[@]}"
            docker manifest push "${IMAGE_NAME}:${TAG}"

            echo "âœ… Success! Manifest pushed."
            echo "::endgroup::"
          done
